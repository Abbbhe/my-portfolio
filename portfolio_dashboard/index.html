<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portfolio Pro v3.6 (Mobile Ready)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --bg-color: #0d0d0d;
            --card-bg: #1c1c1e;
            --sidebar-bg: #161618;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --accent-green: #30d158;
            --accent-red: #ff453a;
            --accent-blue: #0a84ff;
            --border-color: #2c2c2e;
            --input-bg: #2c2c2e;
            --hover-bg: #3a3a3c;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Sidebar (Desktop & Mobile Drawer) --- */
        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 25px;
            color: var(--text-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Overlay for mobile when sidebar is open */
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 90;
            display: none;
            backdrop-filter: blur(2px);
        }

        .save-indicator {
            font-size: 0.7rem; padding: 2px 6px; border-radius: 4px;
            background: #333; color: #aaa; font-weight: normal; transition: 0.3s;
        }
        .save-indicator.saved { color: var(--accent-green); background: rgba(48, 209, 88, 0.1); }

        .section-label {
            font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary);
            margin: 20px 0 10px; letter-spacing: 1px; font-weight: 600;
        }

        .input-group { margin-bottom: 12px; position: relative; }
        .input-group label { display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-secondary); }
        .input-group input {
            width: 100%; padding: 12px; /* Larger touch target */
            background-color: var(--input-bg);
            border: 1px solid transparent; border-radius: 8px;
            color: var(--text-primary); font-size: 0.95rem; box-sizing: border-box;
            transition: border 0.2s;
        }
        .input-group input:focus { outline: none; border-color: var(--accent-blue); }

        .helper-link {
            font-size: 0.75rem; color: var(--accent-blue); text-decoration: none;
            cursor: pointer; margin-top: 6px; display: inline-block; padding: 2px 0;
        }

        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-weight: 600; cursor: pointer; font-size: 0.95rem; margin-top: 8px;
            transition: transform 0.1s, opacity 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--accent-blue); color: white; }
        .btn-success { background-color: var(--accent-green); color: black; }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); }
        .btn-group { display: flex; gap: 10px; }
        .btn-half { flex: 1; }

        /* --- Main Content --- */
        .main-content {
            flex-grow: 1; display: flex; flex-direction: column;
            height: 100vh; overflow: hidden; position: relative;
            width: 100%; /* Ensure full width */
        }

        /* Top Bar */
        .top-bar {
            background-color: rgba(28, 28, 30, 0.95);
            padding: 15px 20px; 
            border-bottom: 1px solid var(--border-color);
            display: flex; 
            justify-content: flex-start; /* Changed for mobile menu */
            align-items: center; 
            z-index: 10;
            gap: 20px;
        }

        /* Mobile Menu Button */
        .menu-btn {
            display: none; /* Hidden on desktop */
            background: none; border: none; color: var(--text-primary);
            font-size: 1.5rem; cursor: pointer; padding: 5px;
        }

        .status-container { 
            display: flex; gap: 40px; flex-grow: 1; 
            justify-content: space-between; /* Spread items */
        }
        .status-item { display: flex; flex-direction: column; }
        .status-label { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 2px; }
        .status-value { font-size: 1.1rem; font-weight: 700; font-variant-numeric: tabular-nums; }
        .status-highlight { color: var(--accent-green); }

        /* Unified Chart Area */
        .chart-section {
            flex-grow: 1; padding: 20px; display: flex; flex-direction: column; overflow-y: auto;
        }

        .chart-card {
            background-color: var(--card-bg); border-radius: 16px;
            padding: 20px; border: 1px solid var(--border-color);
            flex-grow: 1; display: flex; flex-direction: column; position: relative;
            min-height: 400px;
        }

        /* Controls */
        .controls-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; gap: 15px; flex-wrap: wrap;
        }

        .toggle-wrapper {
            display: flex; background: var(--input-bg); border-radius: 8px; padding: 3px;
        }
        .toggle-btn {
            padding: 8px 16px; border-radius: 6px; cursor: pointer;
            font-size: 0.85rem; font-weight: 600; color: var(--text-secondary);
            transition: all 0.2s; user-select: none;
        }
        .toggle-btn.active {
            background-color: var(--hover-bg); color: var(--text-primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .time-ranges {
            display: flex; gap: 5px; flex-wrap: wrap; /* Allow wrap on mobile */
        }
        .time-btn {
            background: transparent; border: none; color: var(--text-secondary);
            font-size: 0.85rem; font-weight: 600; cursor: pointer;
            padding: 6px 12px; border-radius: 6px;
        }
        .time-btn.active { color: var(--accent-blue); background-color: rgba(10, 132, 255, 0.15); }

        .chart-wrapper { flex-grow: 1; position: relative; width: 100%; min-height: 250px; }
        
        input[type="file"] { font-size: 0.8rem; color: var(--text-secondary); }

        /* --- MOBILE RESPONSIVE STYLES --- */
        @media (max-width: 768px) {
            .menu-btn { display: block; } /* Show hamburger */
            
            .sidebar {
                position: fixed;
                top: 0; left: 0;
                height: 100%;
                width: 80%; /* Takes 80% of screen width */
                max-width: 300px;
                transform: translateX(-100%); /* Hide off-screen */
                box-shadow: 4px 0 15px rgba(0,0,0,0.5);
            }
            .sidebar.open { transform: translateX(0); } /* Slide in */
            
            .sidebar-overlay.active { display: block; }

            .top-bar {
                padding: 10px 15px;
                gap: 15px;
            }

            .status-container {
                display: grid;
                grid-template-columns: 1fr 1fr; /* 2x2 Grid */
                gap: 10px 20px;
            }
            .status-item { align-items: flex-start; }
            .status-value { font-size: 1rem; }

            .chart-section { padding: 10px; }
            .chart-card { padding: 15px; min-height: 0; /* Let flex handle height */ }
            
            .controls-bar { flex-direction: column; align-items: stretch; gap: 12px; }
            .toggle-wrapper { justify-content: center; }
            .time-ranges { justify-content: center; gap: 4px; }
            .time-btn { padding: 6px 10px; font-size: 0.8rem; flex: 1; text-align: center; }
        }
    </style>
</head>
<body>

    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            Portfolio Pro
            <span id="saveStatus" class="save-indicator">Ready</span>
        </div>

        <div class="section-label">Data</div>
        <div class="input-group">
            <input type="file" id="fileUpload" accept=".xlsx, .xls, .csv">
        </div>
        <button class="btn btn-primary" onclick="handleFileUpload()">ðŸ“‚ Load File</button>
        <div class="btn-group">
            <button class="btn btn-outline btn-half" onclick="exportData('xlsx')">Expt XLSX</button>
            <button class="btn btn-outline btn-half" onclick="exportData('csv')">Expt CSV</button>
        </div>

        <div class="section-label">Manual Update</div>
        <div class="input-group">
            <label>Date</label>
            <input type="date" id="inputDate">
            <a class="helper-link" onclick="setNextDay()">Next Day (+1)</a>
        </div>
        <div class="input-group">
            <label>Account Value ($)</label>
            <input type="number" id="inputValue" step="0.01">
        </div>
        <div class="input-group">
            <label>Net Deposits ($)</label>
            <input type="number" id="inputDeposit" step="0.01">
            <a class="helper-link" onclick="copyLastDeposit()">Same as Last</a>
        </div>
        <button class="btn btn-success" onclick="addManualData()">+ Add Entry</button>
        <button class="btn btn-outline" onclick="clearAllData()" style="margin-top:20px; border-color: var(--accent-red); color: var(--accent-red)">Reset</button>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>

            <div class="status-container">
                <div class="status-item">
                    <span class="status-label">Up To</span>
                    <span class="status-value status-highlight" id="disp-date">--</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Value</span>
                    <span class="status-value" id="disp-val">--</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Gain</span>
                    <span class="status-value" id="disp-gain">--</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Yield</span>
                    <span class="status-value" id="disp-yield">--</span>
                </div>
            </div>
        </div>

        <div class="chart-section">
            <div class="chart-card">
                <div class="controls-bar">
                    <div class="toggle-wrapper">
                        <div class="toggle-btn active" id="btn-mode-val" onclick="setMode('value')">Value ($)</div>
                        <div class="toggle-btn" id="btn-mode-pct" onclick="setMode('percent')">Yield (%)</div>
                    </div>

                    <div class="time-ranges">
                        <button class="time-btn" onclick="setTimeRange('1W')">1W</button>
                        <button class="time-btn" onclick="setTimeRange('1M')">1M</button>
                        <button class="time-btn" onclick="setTimeRange('3M')">3M</button>
                        <button class="time-btn" onclick="setTimeRange('6M')">6M</button>
                        <button class="time-btn" onclick="setTimeRange('YTD')">YTD</button>
                        <button class="time-btn" onclick="setTimeRange('1Y')">1Y</button>
                        <button class="time-btn active" onclick="setTimeRange('ALL')">ALL</button>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. STATE & DATA ---
        let portfolioData = [];
        let chartInstance = null;
        let currentMode = 'value'; // 'value' or 'percent'
        let currentRange = 'ALL';
        const STORAGE_KEY = 'portfolio_data_v3';

        // Load / Save
        function loadFromStorage() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try { portfolioData = JSON.parse(saved); showSaveStatus("Loaded"); }
                catch (e) { portfolioData = []; }
            } else { portfolioData = []; }
        }
        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(portfolioData));
            showSaveStatus("Saved");
        }
        function showSaveStatus(msg) {
            const el = document.getElementById('saveStatus');
            el.innerText = msg; el.classList.add('saved');
            setTimeout(() => { el.classList.remove('saved'); el.innerText = "Ready"; }, 2000);
        }

        document.getElementById('inputDate').valueAsDate = new Date();

        // --- 2. MOBILE INTERACTION ---
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ol = document.getElementById('overlay');
            sb.classList.toggle('open');
            ol.classList.toggle('active');
        }

        // --- 3. DATA PROCESSING ---
        function getSortedData() {
            return [...portfolioData].sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        function processData() {
            const sorted = getSortedData();
            return sorted.map(item => {
                const netGain = item.value - item.deposit;
                const yieldPct = item.deposit !== 0 ? (netGain / item.deposit) * 100 : 0;
                return { x: item.date, yGain: netGain, yYield: yieldPct, ...item };
            });
        }

        // --- 4. CONTROLS LOGIC ---
        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btn-mode-val').classList.toggle('active', mode === 'value');
            document.getElementById('btn-mode-pct').classList.toggle('active', mode === 'percent');
            updateChart();
        }

        function setTimeRange(range) {
            currentRange = range;
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.toggle('active', btn.innerText === range);
            });
            updateChart();
        }

        // --- 5. CHART RENDERING ---
        function updateHeader(processed) {
            if (!processed.length) {
                ['disp-date', 'disp-val', 'disp-gain', 'disp-yield'].forEach(id => document.getElementById(id).innerText = '--');
                return;
            }
            const last = processed[processed.length - 1];
            // Format Date safely (assume local or UTC split)
            const parts = last.date.split('-');
            const dateObj = new Date(parts[0], parts[1]-1, parts[2]); 
            
            document.getElementById('disp-date').innerText = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' }); // Shorten year for mobile
            document.getElementById('disp-val').innerText = `$${last.value.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:0})}`; // Remove cents for cleaner mobile view if large
            
            const gainEl = document.getElementById('disp-gain');
            gainEl.innerText = (last.yGain>=0?'+':'') + `$${last.yGain.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:0})}`;
            gainEl.style.color = last.yGain>=0 ? 'var(--accent-green)' : 'var(--accent-red)';

            const yieldEl = document.getElementById('disp-yield');
            yieldEl.innerText = (last.yYield>=0?'+':'') + `${last.yYield.toFixed(2)}%`;
            yieldEl.style.color = last.yYield>=0 ? 'var(--accent-green)' : 'var(--accent-red)';
        }

        function updateChart() {
            const allData = processData();
            updateHeader(allData);

            if (allData.length === 0) return;

            // 1. Filter Logic for Time Range
            const lastDate = new Date(allData[allData.length - 1].x);
            let minDate = null;

            if (currentRange === '1W') minDate = moment(lastDate).subtract(1, 'weeks');
            else if (currentRange === '1M') minDate = moment(lastDate).subtract(1, 'months');
            else if (currentRange === '3M') minDate = moment(lastDate).subtract(3, 'months');
            else if (currentRange === '6M') minDate = moment(lastDate).subtract(6, 'months');
            else if (currentRange === '1Y') minDate = moment(lastDate).subtract(1, 'years');
            else if (currentRange === 'YTD') minDate = moment(lastDate).startOf('year');
            
            // Hard Limits for Pan/Zoom
            const dataStart = new Date(allData[0].x).getTime();
            const dataEnd = lastDate.getTime();
            const buffer = 12 * 3600 * 1000; // 12h buffer

            // Config Variables
            const isPct = (currentMode === 'percent');
            const dataKey = isPct ? 'yYield' : 'yGain';
            const label = isPct ? 'Yield %' : 'Net Gain $';

            const ctx = document.getElementById('mainChart').getContext('2d');

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: label,
                        data: allData.map(d => ({x: d.x, y: d[dataKey]})),
                        borderColor: '#e0e0e0',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHitRadius: 25, /* Larger hit radius for touch */
                        pointHoverRadius: 5,
                        fill: {
                            target: 'origin',
                            above: 'rgba(48, 209, 88, 0.15)', // Green tint
                            below: 'rgba(255, 69, 58, 0.15)'  // Red tint
                        },
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'month', tooltipFormat: 'MMM D, YYYY' },
                            grid: { color: '#2c2c2e' },
                            ticks: { color: '#8e8e93', maxRotation: 0, autoSkip: true },
                            // Apply Time Range Filter
                            min: minDate ? minDate.valueOf() : dataStart - buffer,
                            max: dataEnd + buffer
                        },
                        y: {
                            grid: { color: '#2c2c2e' },
                            ticks: { 
                                color: '#8e8e93',
                                callback: val => isPct ? val + '%' : '$' + val
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        zoom: {
                            limits: {
                                x: {
                                    min: dataStart - buffer,
                                    max: dataEnd + buffer,
                                    minRange: 86400000 * 2 // Min 2 days
                                }
                            },
                            zoom: {
                                wheel: { enabled: true },
                                pinch: { enabled: true },
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(28, 28, 30, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#333',
                            borderWidth: 1,
                            callbacks: {
                                label: ctx => {
                                    let val = ctx.parsed.y;
                                    return label + ': ' + (isPct ? val.toFixed(2) + '%' : '$' + val.toLocaleString());
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- 6. HANDLERS & HELPERS ---
        function setNextDay() {
            let dateVal = document.getElementById('inputDate').value;
            if (!dateVal && portfolioData.length > 0) {
                const sorted = getSortedData();
                dateVal = sorted[sorted.length - 1].date;
            }
            let baseDate = dateVal ? new Date(dateVal) : new Date();
            baseDate.setDate(baseDate.getDate() + 1);
            document.getElementById('inputDate').value = baseDate.toISOString().split('T')[0];
        }

        function copyLastDeposit() {
            if (portfolioData.length === 0) return alert("No previous data.");
            const sorted = getSortedData();
            document.getElementById('inputDeposit').value = sorted[sorted.length - 1].deposit;
        }

        function addManualData() {
            const date = document.getElementById('inputDate').value;
            const value = parseFloat(document.getElementById('inputValue').value);
            const deposit = parseFloat(document.getElementById('inputDeposit').value);

            if (!date || isNaN(value) || isNaN(deposit)) return alert("Invalid Input");

            const idx = portfolioData.findIndex(d => d.date === date);
            if (idx >= 0) portfolioData[idx] = {date, value, deposit};
            else portfolioData.push({date, value, deposit});

            saveToStorage();
            document.getElementById('inputValue').value = '';
            updateChart();
            // Close sidebar on mobile after add
            if(window.innerWidth <= 768) toggleSidebar();
        }

        function clearAllData() {
            if(confirm("Delete all data?")) {
                portfolioData = [];
                saveToStorage();
                updateChart();
            }
        }

        function exportData(type) {
            if(portfolioData.length === 0) return alert("No data");
            const sorted = processData().map(d => ({
                Date: d.date,
                "Account Value": d.value,
                "Net Deposits": d.deposit,
                "Net Gain": d.yGain,
                "Yield %": (d.yYield/100).toFixed(4)
            }));
            const ws = XLSX.utils.json_to_sheet(sorted);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Portfolio");
            const fname = `portfolio_${new Date().toISOString().split('T')[0]}`;
            XLSX.writeFile(wb, fname + (type === 'xlsx' ? ".xlsx" : ".csv"));
        }

        function handleFileUpload() {
            const file = document.getElementById('fileUpload').files[0];
            if (!file) return alert("Select file");
            const reader = new FileReader();
            reader.onload = e => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {raw: false});
                
                const newData = json.map(row => {
                    const keys = Object.keys(row);
                    const kDate = keys.find(k => k.match(/date/i));
                    const kVal = keys.find(k => k.match(/value|amount|total/i));
                    const kDep = keys.find(k => k.match(/deposit|cost|invested/i));
                    if (kDate && kVal && kDep) {
                        return {
                            date: new Date(row[kDate]).toISOString().split('T')[0],
                            value: parseFloat(String(row[kVal]).replace(/[$,]/g,'')),
                            deposit: parseFloat(String(row[kDep]).replace(/[$,]/g,''))
                        };
                    }
                    return null;
                }).filter(d => d && !isNaN(d.value));

                if (newData.length) {
                    portfolioData = newData; saveToStorage(); updateChart();
                    alert(`Loaded ${newData.length} rows.`);
                    if(window.innerWidth <= 768) toggleSidebar();
                } else alert("Parse error. Check headers.");
            };
            reader.readAsArrayBuffer(file);
        }

        // Init
        window.onload = function() {
            loadFromStorage();
            updateChart();
        };

    </script>
</body>
</html>